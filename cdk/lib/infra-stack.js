"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cdk = require("@aws-cdk/cdk");
const ec2 = require("@aws-cdk/aws-ec2");
const elbv2 = require("@aws-cdk/aws-elasticloadbalancingv2");
const ecs = require("@aws-cdk/aws-ecs");
// import sd = require('@aws-cdk/aws-servicediscovery');
const iam = require("@aws-cdk/aws-iam");
class SrvStack extends cdk.Construct {
    constructor(scope, id, props) {
        super(scope, id);
        if (props.useLoadBalancer && !props.lbContainerPort) {
            throw new cdk.ValidationError(this, 'lbContainerPort is required when setting useLoadBalancer to true');
        }
        let image;
        if (props.fromPath) {
            image = ecs.ContainerImage.fromAsset(this, `${props.name}SrvImage`, { directory: props.image });
            new cdk.CfnOutput(this, `${props.name}ECRImage`, { value: image.imageName });
        }
        else {
            image = ecs.ContainerImage.fromRegistry(props.image);
        }
        const envs = props.envVars || {};
        if (props.cluster.defaultNamespace) {
            envs['MICRO_REGISTRY'] = 'cloudmap';
            envs['MICRO_CLOUDMAP_DOMAIN'] = props.cluster.defaultNamespace.namespaceName;
            envs['MICRO_CLOUDMAP_NAMESPACEID'] = props.cluster.defaultNamespace.namespaceId;
        }
        const def = new ecs.FargateTaskDefinition(this, `${props.name}SrvTaskDefinition`);
        const container = def.addContainer('srv', {
            image: image,
            logging: new ecs.AwsLogDriver(this, 'TaskLogging', { streamPrefix: `${props.name}-log-` }),
            command: props.commandOverride ? props.commandOverride : undefined,
            environment: envs
        });
        def.addToTaskRolePolicy(newSDIAMPolicy());
        const srv = this.service = new ecs.FargateService(this, `${props.name}Service`, {
            cluster: props.cluster,
            taskDefinition: def,
            securityGroup: props.serviceSG ? props.serviceSG : undefined,
            serviceDiscoveryOptions: { name: props.name, dnsTtlSec: 30, failureThreshold: 2 }
        });
        if (props.useLoadBalancer) {
            container.addPortMappings({
                containerPort: props.lbContainerPort || 80,
            });
            const lb = new elbv2.ApplicationLoadBalancer(this, 'LB', { internetFacing: true, vpc: props.cluster.vpc });
            const listener = lb.addListener('PublicListener', { port: 80, open: true });
            const tg = listener.addTargets('FargateCluster', { port: 80 });
            if (props.lbHealthCheckPath) {
                tg.configureHealthCheck({ path: props.lbHealthCheckPath });
            }
            tg.addTarget(srv);
            new cdk.CfnOutput(this, `${props.name}LoadBalancerDNS`, { value: lb.dnsName });
        }
    }
}
exports.SrvStack = SrvStack;
class InfraStack extends cdk.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);
        const vpc = this.vpc = new ec2.VpcNetwork(this, 'Vpc', { natGateways: 1, maxAZs: 2 });
        this.serviceDiscoveryDomain = 'microcdk.int';
        this.cluster = new ecs.Cluster(this, 'FargateCluster', { vpc });
        this.cluster.addDefaultCloudMapNamespace({ name: this.serviceDiscoveryDomain });
        this.serviceSG = new ec2.SecurityGroup(this, 'ServiceSG', { allowAllOutbound: true, vpc });
        this.serviceSG.connections.allowInternally(new ec2.TcpAllPorts);
        this.serviceSG.connections.allowInternally(new ec2.UdpAllPorts);
        // micro api is core infrastructure, building here
        const microImage = ecs.ContainerImage.fromAsset(this, 'MicroApiImage', { directory: '../microapi' });
        new cdk.CfnOutput(this, 'MicroApiECRRepo', { value: microImage.imageName });
        // const microapi =
        //   new ecs.LoadBalancedFargateService(this, 'MicroApiService', {
        //     cluster: this.cluster,
        //     image: microImage,
        //     containerPort: 8090,
        //     environment: {
        //       'MICRO_API_HANDLER': 'api',
        //       'MICRO_API_ADDRESS': '0.0.0.0:8090',
        //       'MICRO_REGISTRY': 'cloudmap',
        //       'MICRO_CLOUDMAP_DOMAIN': this.cluster.defaultNamespace!.namespaceName,
        //       'MICRO_CLOUDMAP_NAMESPACEID': this.cluster.defaultNamespace!.namespaceId,
        //     }
        //   });
        const microapi = new SrvStack(this, 'MicroAPI', {
            name: 'microapi',
            cluster: this.cluster,
            serviceSG: this.serviceSG,
            fromPath: true,
            image: '../microapi',
            lbContainerPort: 8090,
            useLoadBalancer: true,
            lbHealthCheckPath: "/stats",
            serviceDiscoveryDomain: this.serviceDiscoveryDomain,
            envVars: { 'MICRO_API_ADDRESS': '0.0.0.0:8090' },
        });
        this.serviceSG.connections.allowFrom(microapi.service, new ec2.TcpAllPorts);
        new cdk.CfnOutput(this, 'VpcId', { value: this.vpc.vpcId });
        new cdk.CfnOutput(this, 'ClusterARN', { value: this.cluster.clusterArn });
    }
}
exports.InfraStack = InfraStack;
function newSDIAMPolicy() {
    return new iam.PolicyStatement(iam.PolicyStatementEffect.Allow)
        .addActions("servicediscovery:CreateService", "servicediscovery:DeleteService", "servicediscovery:DeregisterInstance", "servicediscovery:DiscoverInstances", "servicediscovery:GetInstance", "servicediscovery:GetInstancesHealthStatus", "servicediscovery:GetNamespace", "servicediscovery:GetOperation", "servicediscovery:GetService", "servicediscovery:ListInstances", "servicediscovery:ListNamespaces", "servicediscovery:ListOperations", "servicediscovery:ListServices", "servicediscovery:RegisterInstance", "servicediscovery:UpdateInstanceCustomHealthStatus", "servicediscovery:UpdateService", "route53:GetHealthCheck", "route53:DeleteHealthCheck", "route53:DeleteHealthCheck", "route53:UpdateHealthCheck", "route53:ChangeResourceRecordSets").addAllResources();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5mcmEtc3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmZyYS1zdGFjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG9DQUFxQztBQUNyQyx3Q0FBeUM7QUFDekMsNkRBQThEO0FBQzlELHdDQUF5QztBQUN6Qyx3REFBd0Q7QUFDeEQsd0NBQXlDO0FBRXpDLE1BQWEsUUFBUyxTQUFRLEdBQUcsQ0FBQyxTQUFTO0lBR3pDLFlBQVksS0FBb0IsRUFBRSxFQUFVLEVBQUUsS0FBb0I7UUFDaEUsS0FBSyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQTtRQUVoQixJQUFJLEtBQUssQ0FBQyxlQUFlLElBQUksQ0FBQyxLQUFLLENBQUMsZUFBZSxFQUFFO1lBQ25ELE1BQU0sSUFBSSxHQUFHLENBQUMsZUFBZSxDQUFDLElBQUksRUFBRSxrRUFBa0UsQ0FBQyxDQUFDO1NBQ3pHO1FBRUQsSUFBSSxLQUF5QixDQUFDO1FBQzlCLElBQUksS0FBSyxDQUFDLFFBQVEsRUFBRTtZQUNsQixLQUFLLEdBQUcsR0FBRyxDQUFDLGNBQWMsQ0FBQyxTQUFTLENBQ2xDLElBQUksRUFBRSxHQUFHLEtBQUssQ0FBQyxJQUFJLFVBQVUsRUFBRSxFQUFFLFNBQVMsRUFBRSxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztZQUM3RCxJQUFJLEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLEdBQUcsS0FBSyxDQUFDLElBQUksVUFBVSxFQUFFLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFBO1NBQzdFO2FBQU07WUFDTCxLQUFLLEdBQUcsR0FBRyxDQUFDLGNBQWMsQ0FBQyxZQUFZLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ3REO1FBRUQsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUE7UUFDaEMsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLGdCQUFnQixF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SSxHQUFHLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxxQkFBcUIsQ0FBQyxLQUFLLENBQUM7U0FDNUQsVUFBVSxDQUNULGdDQUFnQyxFQUNoQyxnQ0FBZ0MsRUFDaEMscUNBQXFDLEVBQ3JDLG9DQUFvQyxFQUNwQyw4QkFBOEIsRUFDOUIsMkNBQTJDLEVBQzNDLCtCQUErQixFQUMvQiwrQkFBK0IsRUFDL0IsNkJBQTZCLEVBQzdCLGdDQUFnQyxFQUNoQyxpQ0FBaUMsRUFDakMsaUNBQWlDLEVBQ2pDLCtCQUErQixFQUMvQixtQ0FBbUMsRUFDbkMsbURBQW1ELEVBQ25ELGdDQUFnQyxFQUNoQyx3QkFBd0IsRUFDeEIsMkJBQTJCLEVBQzNCLDJCQUEyQixFQUMzQiwyQkFBMkIsRUFDM0Isa0NBQWtDLENBQ25DLENBQUMsZUFBZSxFQUFFLENBQUE7QUFDdkIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjZGsgPSByZXF1aXJlKCdAYXdzLWNkay9jZGsnKTtcbmltcG9ydCBlYzIgPSByZXF1aXJlKCdAYXdzLWNkay9hd3MtZWMyJyk7XG5pbXBvcnQgZWxidjIgPSByZXF1aXJlKCdAYXdzLWNkay9hd3MtZWxhc3RpY2xvYWRiYWxhbmNpbmd2MicpO1xuaW1wb3J0IGVjcyA9IHJlcXVpcmUoJ0Bhd3MtY2RrL2F3cy1lY3MnKTtcbi8vIGltcG9ydCBzZCA9IHJlcXVpcmUoJ0Bhd3MtY2RrL2F3cy1zZXJ2aWNlZGlzY292ZXJ5Jyk7XG5pbXBvcnQgaWFtID0gcmVxdWlyZSgnQGF3cy1jZGsvYXdzLWlhbScpO1xuXG5leHBvcnQgY2xhc3MgU3J2U3RhY2sgZXh0ZW5kcyBjZGsuQ29uc3RydWN0IHtcbiAgcHVibGljIHJlYWRvbmx5IHNlcnZpY2U6IGVjcy5GYXJnYXRlU2VydmljZTtcblxuICBjb25zdHJ1Y3RvcihzY29wZTogY2RrLkNvbnN0cnVjdCwgaWQ6IHN0cmluZywgcHJvcHM6IFNydlN0YWNrUHJvcHMpIHtcbiAgICBzdXBlcihzY29wZSwgaWQpXG5cbiAgICBpZiAocHJvcHMudXNlTG9hZEJhbGFuY2VyICYmICFwcm9wcy5sYkNvbnRhaW5lclBvcnQpIHtcbiAgICAgIHRocm93IG5ldyBjZGsuVmFsaWRhdGlvbkVycm9yKHRoaXMsICdsYkNvbnRhaW5lclBvcnQgaXMgcmVxdWlyZWQgd2hlbiBzZXR0aW5nIHVzZUxvYWRCYWxhbmNlciB0byB0cnVlJyk7XG4gICAgfVxuXG4gICAgbGV0IGltYWdlOiBlY3MuQ29udGFpbmVySW1hZ2U7XG4gICAgaWYgKHByb3BzLmZyb21QYXRoKSB7XG4gICAgICBpbWFnZSA9IGVjcy5Db250YWluZXJJbWFnZS5mcm9tQXNzZXQoXG4gICAgICAgIHRoaXMsIGAke3Byb3BzLm5hbWV9U3J2SW1hZ2VgLCB7IGRpcmVjdG9yeTogcHJvcHMuaW1hZ2UgfSk7XG4gICAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCBgJHtwcm9wcy5uYW1lfUVDUkltYWdlYCwgeyB2YWx1ZTogaW1hZ2UuaW1hZ2VOYW1lIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIGltYWdlID0gZWNzLkNvbnRhaW5lckltYWdlLmZyb21SZWdpc3RyeShwcm9wcy5pbWFnZSk7XG4gICAgfVxuXG4gICAgY29uc3QgZW52cyA9IHByb3BzLmVudlZhcnMgfHwge31cbiAgICBpZiAocHJvcHMuY2x1c3Rlci5kZWZhdWx0TmFtZXNwYWNlKSB7XG4gICAgICBlbnZzWydNSUNST19SRUdJU1RSWSddID0gJ2Nsb3VkbWFwJztcbiAgICAgIGVudnNbJ01JQ1JPX0NMT1VETUFQX0RPTUFJTiddID0gcHJvcHMuY2x1c3Rlci5kZWZhdWx0TmFtZXNwYWNlLm5hbWVzcGFjZU5hbWU7XG4gICAgICBlbnZzWydNSUNST19DTE9VRE1BUF9OQU1FU1BBQ0VJRCddID0gcHJvcHMuY2x1c3Rlci5kZWZhdWx0TmFtZXNwYWNlLm5hbWVzcGFjZUlkO1xuICAgIH1cblxuICAgIGNvbnN0IGRlZiA9XG4gICAgICBuZXcgZWNzLkZhcmdhdGVUYXNrRGVmaW5pdGlvbih0aGlzLCBgJHtwcm9wcy5uYW1lfVNydlRhc2tEZWZpbml0aW9uYCk7XG4gICAgY29uc3QgY29udGFpbmVyID0gZGVmLmFkZENvbnRhaW5lcignc3J2Jywge1xuICAgICAgaW1hZ2U6IGltYWdlLFxuICAgICAgbG9nZ2luZzogbmV3IGVjcy5Bd3NMb2dEcml2ZXIoXG4gICAgICAgIHRoaXMsICdUYXNrTG9nZ2luZycsIHsgc3RyZWFtUHJlZml4OiBgJHtwcm9wcy5uYW1lfS1sb2ctYCB9KSxcbiAgICAgIGNvbW1hbmQ6IHByb3BzLmNvbW1hbmRPdmVycmlkZSA/IHByb3BzLmNvbW1hbmRPdmVycmlkZSA6IHVuZGVmaW5lZCxcbiAgICAgIGVudmlyb25tZW50OiBlbnZzXG4gICAgfSk7XG4gICAgZGVmLmFkZFRvVGFza1JvbGVQb2xpY3kobmV3U0RJQU1Qb2xpY3koKSlcblxuICAgIGNvbnN0IHNydiA9IHRoaXMuc2VydmljZSA9IG5ldyBlY3MuRmFyZ2F0ZVNlcnZpY2UodGhpcywgYCR7cHJvcHMubmFtZX1TZXJ2aWNlYCwge1xuICAgICAgY2x1c3RlcjogcHJvcHMuY2x1c3RlcixcbiAgICAgIHRhc2tEZWZpbml0aW9uOiBkZWYsXG4gICAgICBzZWN1cml0eUdyb3VwOiBwcm9wcy5zZXJ2aWNlU0cgPyBwcm9wcy5zZXJ2aWNlU0cgOiB1bmRlZmluZWQsXG4gICAgICBzZXJ2aWNlRGlzY292ZXJ5T3B0aW9uczpcbiAgICAgICAgeyBuYW1lOiBwcm9wcy5uYW1lLCBkbnNUdGxTZWM6IDMwLCBmYWlsdXJlVGhyZXNob2xkOiAyIH1cbiAgICB9KTtcblxuXG4gICAgaWYgKHByb3BzLnVzZUxvYWRCYWxhbmNlcikge1xuICAgICAgY29udGFpbmVyLmFkZFBvcnRNYXBwaW5ncyh7XG4gICAgICAgIGNvbnRhaW5lclBvcnQ6IHByb3BzLmxiQ29udGFpbmVyUG9ydCB8fCA4MCxcbiAgICAgIH0pXG4gICAgICBjb25zdCBsYiA9IG5ldyBlbGJ2Mi5BcHBsaWNhdGlvbkxvYWRCYWxhbmNlcihcbiAgICAgICAgdGhpcywgJ0xCJywgeyBpbnRlcm5ldEZhY2luZzogdHJ1ZSwgdnBjOiBwcm9wcy5jbHVzdGVyLnZwYyB9KTtcbiAgICAgIGNvbnN0IGxpc3RlbmVyID0gbGIuYWRkTGlzdGVuZXIoJ1B1YmxpY0xpc3RlbmVyJywgeyBwb3J0OiA4MCwgb3BlbjogdHJ1ZSB9KTtcbiAgICAgIGNvbnN0IHRnID0gbGlzdGVuZXIuYWRkVGFyZ2V0cygnRmFyZ2F0ZUNsdXN0ZXInLCB7IHBvcnQ6IDgwIH0pO1xuICAgICAgaWYgKHByb3BzLmxiSGVhbHRoQ2hlY2tQYXRoKSB7XG4gICAgICAgIHRnLmNvbmZpZ3VyZUhlYWx0aENoZWNrKHsgcGF0aDogcHJvcHMubGJIZWFsdGhDaGVja1BhdGggfSk7XG4gICAgICB9XG4gICAgICB0Zy5hZGRUYXJnZXQoc3J2KVxuICAgICAgbmV3IGNkay5DZm5PdXRwdXQoXG4gICAgICAgIHRoaXMsIGAke3Byb3BzLm5hbWV9TG9hZEJhbGFuY2VyRE5TYCwgeyB2YWx1ZTogbGIuZG5zTmFtZSB9KVxuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgSW5mcmFTdGFjayBleHRlbmRzIGNkay5TdGFjayB7XG4gIHB1YmxpYyByZWFkb25seSB2cGM6IGVjMi5WcGNOZXR3b3JrO1xuICBwdWJsaWMgcmVhZG9ubHkgY2x1c3RlcjogZWNzLkNsdXN0ZXI7XG4gIHB1YmxpYyByZWFkb25seSBzZXJ2aWNlRGlzY292ZXJ5RG9tYWluOiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSBzZXJ2aWNlU0c6IGVjMi5TZWN1cml0eUdyb3VwO1xuXG4gIGNvbnN0cnVjdG9yKHNjb3BlOiBjZGsuQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wcz86IGNkay5TdGFja1Byb3BzKSB7XG4gICAgc3VwZXIoc2NvcGUsIGlkLCBwcm9wcyk7XG4gICAgY29uc3QgdnBjID0gdGhpcy52cGMgPSBuZXcgZWMyLlZwY05ldHdvcmsodGhpcywgJ1ZwYycsIHsgbmF0R2F0ZXdheXM6IDEsIG1heEFaczogMiB9KTtcbiAgICB0aGlzLnNlcnZpY2VEaXNjb3ZlcnlEb21haW4gPSAnbWljcm9jZGsuaW50JztcbiAgICB0aGlzLmNsdXN0ZXIgPSBuZXcgZWNzLkNsdXN0ZXIodGhpcywgJ0ZhcmdhdGVDbHVzdGVyJywgeyB2cGMgfSk7XG4gICAgdGhpcy5jbHVzdGVyLmFkZERlZmF1bHRDbG91ZE1hcE5hbWVzcGFjZShcbiAgICAgIHsgbmFtZTogdGhpcy5zZXJ2aWNlRGlzY292ZXJ5RG9tYWluIH0pO1xuXG4gICAgdGhpcy5zZXJ2aWNlU0cgPSBuZXcgZWMyLlNlY3VyaXR5R3JvdXAoXG4gICAgICB0aGlzLCAnU2VydmljZVNHJywgeyBhbGxvd0FsbE91dGJvdW5kOiB0cnVlLCB2cGMgfSk7XG4gICAgdGhpcy5zZXJ2aWNlU0cuY29ubmVjdGlvbnMuYWxsb3dJbnRlcm5hbGx5KG5ldyBlYzIuVGNwQWxsUG9ydHMpO1xuICAgIHRoaXMuc2VydmljZVNHLmNvbm5lY3Rpb25zLmFsbG93SW50ZXJuYWxseShuZXcgZWMyLlVkcEFsbFBvcnRzKTtcblxuICAgIC8vIG1pY3JvIGFwaSBpcyBjb3JlIGluZnJhc3RydWN0dXJlLCBidWlsZGluZyBoZXJlXG4gICAgY29uc3QgbWljcm9JbWFnZSA9IGVjcy5Db250YWluZXJJbWFnZS5mcm9tQXNzZXQoXG4gICAgICB0aGlzLCAnTWljcm9BcGlJbWFnZScsIHsgZGlyZWN0b3J5OiAnLi4vbWljcm9hcGknIH0pO1xuICAgIG5ldyBjZGsuQ2ZuT3V0cHV0KHRoaXMsICdNaWNyb0FwaUVDUlJlcG8nLCB7IHZhbHVlOiBtaWNyb0ltYWdlLmltYWdlTmFtZSB9KTtcblxuICAgIC8vIGNvbnN0IG1pY3JvYXBpID1cbiAgICAvLyAgIG5ldyBlY3MuTG9hZEJhbGFuY2VkRmFyZ2F0ZVNlcnZpY2UodGhpcywgJ01pY3JvQXBpU2VydmljZScsIHtcbiAgICAvLyAgICAgY2x1c3RlcjogdGhpcy5jbHVzdGVyLFxuICAgIC8vICAgICBpbWFnZTogbWljcm9JbWFnZSxcbiAgICAvLyAgICAgY29udGFpbmVyUG9ydDogODA5MCxcbiAgICAvLyAgICAgZW52aXJvbm1lbnQ6IHtcbiAgICAvLyAgICAgICAnTUlDUk9fQVBJX0hBTkRMRVInOiAnYXBpJyxcbiAgICAvLyAgICAgICAnTUlDUk9fQVBJX0FERFJFU1MnOiAnMC4wLjAuMDo4MDkwJyxcbiAgICAvLyAgICAgICAnTUlDUk9fUkVHSVNUUlknOiAnY2xvdWRtYXAnLFxuICAgIC8vICAgICAgICdNSUNST19DTE9VRE1BUF9ET01BSU4nOiB0aGlzLmNsdXN0ZXIuZGVmYXVsdE5hbWVzcGFjZSEubmFtZXNwYWNlTmFtZSxcbiAgICAvLyAgICAgICAnTUlDUk9fQ0xPVURNQVBfTkFNRVNQQUNFSUQnOiB0aGlzLmNsdXN0ZXIuZGVmYXVsdE5hbWVzcGFjZSEubmFtZXNwYWNlSWQsXG4gICAgLy8gICAgIH1cbiAgICAvLyAgIH0pO1xuXG4gICAgY29uc3QgbWljcm9hcGkgPSBuZXcgU3J2U3RhY2sodGhpcywgJ01pY3JvQVBJJywge1xuICAgICAgbmFtZTogJ21pY3JvYXBpJyxcbiAgICAgIGNsdXN0ZXI6IHRoaXMuY2x1c3RlcixcbiAgICAgIHNlcnZpY2VTRzogdGhpcy5zZXJ2aWNlU0csXG4gICAgICBmcm9tUGF0aDogdHJ1ZSxcbiAgICAgIGltYWdlOiAnLi4vbWljcm9hcGknLFxuICAgICAgbGJDb250YWluZXJQb3J0OiA4MDkwLFxuICAgICAgdXNlTG9hZEJhbGFuY2VyOiB0cnVlLFxuICAgICAgbGJIZWFsdGhDaGVja1BhdGg6IFwiL3N0YXRzXCIsXG4gICAgICBzZXJ2aWNlRGlzY292ZXJ5RG9tYWluOiB0aGlzLnNlcnZpY2VEaXNjb3ZlcnlEb21haW4sXG4gICAgICBlbnZWYXJzOiB7ICdNSUNST19BUElfQUREUkVTUyc6ICcwLjAuMC4wOjgwOTAnIH0sXG4gICAgfSk7XG5cbiAgICB0aGlzLnNlcnZpY2VTRy5jb25uZWN0aW9ucy5hbGxvd0Zyb20obWljcm9hcGkuc2VydmljZSwgbmV3IGVjMi5UY3BBbGxQb3J0cyk7XG5cbiAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCAnVnBjSWQnLCB7IHZhbHVlOiB0aGlzLnZwYy52cGNJZCB9KTtcbiAgICBuZXcgY2RrLkNmbk91dHB1dCh0aGlzLCAnQ2x1c3RlckFSTicsIHsgdmFsdWU6IHRoaXMuY2x1c3Rlci5jbHVzdGVyQXJuIH0pO1xuICB9XG59XG5cbmludGVyZmFjZSBTcnZTdGFja1Byb3BzIHtcbiAgY2x1c3RlcjogZWNzLkNsdXN0ZXJcbiAgbmFtZTogc3RyaW5nXG4gIGltYWdlOiBzdHJpbmdcbiAgZnJvbVBhdGg/OiBib29sZWFuXG4gIGNvbW1hbmRPdmVycmlkZT86IHN0cmluZ1tdXG4gIHVzZUxvYWRCYWxhbmNlcj86IGJvb2xlYW5cbiAgbGJIZWFsdGhDaGVja1BhdGg/OiBzdHJpbmdcbiAgbGJDb250YWluZXJQb3J0PzogbnVtYmVyXG4gIHNlcnZpY2VTRzogZWMyLlNlY3VyaXR5R3JvdXBcbiAgc2VydmljZURpc2NvdmVyeURvbWFpbjogc3RyaW5nXG4gIGVudlZhcnM/OiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB9XG59XG5cbmZ1bmN0aW9uIG5ld1NESUFNUG9saWN5KCk6IGlhbS5Qb2xpY3lTdGF0ZW1lbnQge1xuICByZXR1cm4gbmV3IGlhbS5Qb2xpY3lTdGF0ZW1lbnQoaWFtLlBvbGljeVN0YXRlbWVudEVmZmVjdC5BbGxvdylcbiAgICAuYWRkQWN0aW9ucyhcbiAgICAgIFwic2VydmljZWRpc2NvdmVyeTpDcmVhdGVTZXJ2aWNlXCIsXG4gICAgICBcInNlcnZpY2VkaXNjb3Zlcnk6RGVsZXRlU2VydmljZVwiLFxuICAgICAgXCJzZXJ2aWNlZGlzY292ZXJ5OkRlcmVnaXN0ZXJJbnN0YW5jZVwiLFxuICAgICAgXCJzZXJ2aWNlZGlzY292ZXJ5OkRpc2NvdmVySW5zdGFuY2VzXCIsXG4gICAgICBcInNlcnZpY2VkaXNjb3Zlcnk6R2V0SW5zdGFuY2VcIixcbiAgICAgIFwic2VydmljZWRpc2NvdmVyeTpHZXRJbnN0YW5jZXNIZWFsdGhTdGF0dXNcIixcbiAgICAgIFwic2VydmljZWRpc2NvdmVyeTpHZXROYW1lc3BhY2VcIixcbiAgICAgIFwic2VydmljZWRpc2NvdmVyeTpHZXRPcGVyYXRpb25cIixcbiAgICAgIFwic2VydmljZWRpc2NvdmVyeTpHZXRTZXJ2aWNlXCIsXG4gICAgICBcInNlcnZpY2VkaXNjb3Zlcnk6TGlzdEluc3RhbmNlc1wiLFxuICAgICAgXCJzZXJ2aWNlZGlzY292ZXJ5Okxpc3ROYW1lc3BhY2VzXCIsXG4gICAgICBcInNlcnZpY2VkaXNjb3Zlcnk6TGlzdE9wZXJhdGlvbnNcIixcbiAgICAgIFwic2VydmljZWRpc2NvdmVyeTpMaXN0U2VydmljZXNcIixcbiAgICAgIFwic2VydmljZWRpc2NvdmVyeTpSZWdpc3Rlckluc3RhbmNlXCIsXG4gICAgICBcInNlcnZpY2VkaXNjb3Zlcnk6VXBkYXRlSW5zdGFuY2VDdXN0b21IZWFsdGhTdGF0dXNcIixcbiAgICAgIFwic2VydmljZWRpc2NvdmVyeTpVcGRhdGVTZXJ2aWNlXCIsXG4gICAgICBcInJvdXRlNTM6R2V0SGVhbHRoQ2hlY2tcIixcbiAgICAgIFwicm91dGU1MzpEZWxldGVIZWFsdGhDaGVja1wiLFxuICAgICAgXCJyb3V0ZTUzOkRlbGV0ZUhlYWx0aENoZWNrXCIsXG4gICAgICBcInJvdXRlNTM6VXBkYXRlSGVhbHRoQ2hlY2tcIixcbiAgICAgIFwicm91dGU1MzpDaGFuZ2VSZXNvdXJjZVJlY29yZFNldHNcIixcbiAgICApLmFkZEFsbFJlc291cmNlcygpXG59Il19